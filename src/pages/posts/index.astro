---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

// Fetch all posts and sort by date (newest first)
const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
	const year = post.data.pubDate.getFullYear();
	if (!acc[year]) acc[year] = [];
	acc[year].push(post);
	return acc;
}, {} as Record<number, typeof posts>);

// Get years in descending order (newest first)
const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title={`Blog | ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
	<!-- Page heading section -->
	<div class="mb-12">
		<h1 class="font-sans text-4xl font-bold text-dark-gray mb-4">All Posts</h1>
		<p class="text-muted-gray text-lg leading-relaxed">
			{posts.length} {posts.length === 1 ? 'post' : 'posts'} and counting.
		</p>
	</div>

	<!-- Posts grouped by year -->
	{
		years.map((year) => (
			<div class="mb-16 last:mb-0">
				<!-- Year header -->
				<h2 class="font-sans text-3xl font-bold text-dark-gray mb-6">{year}</h2>

				<!-- Post list for this year -->
				<ul class="list-disc pl-5 space-y-2 text-dark-gray text-base leading-relaxed">
					{postsByYear[Number(year)].map((post) => {
						return (
							<li>
								<a href={`/posts/${post.id}/`}>
									{post.data.title}
								</a>
							</li>
						);
					})}
				</ul>
			</div>
		))
	}
</BaseLayout>
